> source("common.R",print.eval=TRUE)
# R version 3.3.3 (2017-03-06) # ramah # FALSE # TRUE
> 
> assert <- function(xx) {
+   if ( ! identical(( s %~% 'R.get("xx")._1' ), xx) ) stop("Not identical (test 1)")
+   if ( ! identical(( s %~% 'R.xx._1' ), xx) ) stop("Not identical (test 2)")
+   s$xx <- xx
+   s %@% 'R.a = xx'
+   if ( ! identical(a, xx) ) stop("Not identical (test 3)")
+   if ( ! identical(s$.R$get(I("xx"))$"_1"(), xx) ) stop("Not identical (test 4)")
+   m <- s$def() %~% 'R.get("xx")._1'
+   if ( ! identical(m(), xx) ) stop("Not identical (test 5)")
+ }
> 
> y <- c(0,1,2,3,4,5,6,8)
> for ( x in list(as.integer(y),as.double(y),as.logical(y),as.character(y),as.raw(y)) ) {
+   assert(x[1])
+   assert(x[2])
+   assert(x)
+   assert(matrix(x,nrow=1))
+   assert(matrix(x,nrow=2))
+   assert(matrix(x,nrow=4))
+ }
> 
> counter <- 0
> for ( i in 1:10 ) {
+   s %~% 'R.eval("counter <- counter + 1")'
+ }
> if ( counter != 10 ) stop("Counter is off.")
> for ( i in 1:10 ) {
+   s$.R$eval(I("counter <<- counter - 1"))
+ }
> if ( counter != 0 ) stop("Counter is off.")
> 
> 
> # Should be a compile-time error because 'ewf' is not defined.
> tryCatch(s %~% '
+   3+4+ewf
+   R.eval("""
+     cat("I love Lisa!\n")
+     a <- "3+9"
+   """)
+ ',error=function(e) e)
<console>:13: error: not found: value ewf
  3+4+ewf
      ^
<simpleError in scalaEval(interpreter, snippet, workspace): Error in evaluation.>
> s %~% '3+2'
[1] 5
> 
> 
> # Should be an R evaluation error because 'asfd' is not defined and out of place.
> tryCatch(s %~% '
+   3+4
+   R.eval("""
+     cat("I love Lisa!\n")
+     a <- "3+9" asfd
+   """)
+ ',error=function(e) e)
<console>:13: warning: a pure expression does nothing in statement position; multiline expressions may require enclosing parentheses
  3+4
   ^
Error in parse(text = snippet) : <text>:4:16: unexpected symbol
3: ")
4:     a <- "3+9" asfd
                  ^
<text>:4:16: unexpected symbol
3: ")
4:     a <- "3+9" asfd
                  ^
java.lang.RuntimeException: Error in R evaluation.
  at org.ddahl.rscala.RClient.eval(RClient.scala:80)
  ... 54 elided
<simpleError in scalaEval(interpreter, snippet, workspace): Error in evaluation.>
> s %~% '3+6'
[1] 9
> 
> 
> myMean <- function(x) {
+   cat("Here is am.\n")
+   mean(x)
+ }
> 
> callRFunction <- s$def(functionName=I(""), x=numeric()) %~% '
+   R.xx = x
+   R.eval("y <- "+functionName+"(xx)")
+   R.y._1
+ '
> 
> tryCatch(callRFunction(1:100),error = function(e) {})
java.lang.reflect.InvocationTargetException
	at sun.reflect.GeneratedMethodAccessor2.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.ddahl.rscala.ScalaServer.doInvoke(ScalaServer.scala:158)
	at org.ddahl.rscala.ScalaServer.heart(ScalaServer.scala:524)
	at org.ddahl.rscala.ScalaServer.run(ScalaServer.scala:551)
	at org.ddahl.rscala.Main$.delayedEndpoint$org$ddahl$rscala$Main$1(Main.scala:5)
	at org.ddahl.rscala.Main$delayedInit$body.apply(Main.scala:3)
	at scala.Function0.apply$mcV$sp(Function0.scala:34)
	at scala.Function0.apply$mcV$sp$(Function0.scala:34)
	at scala.runtime.AbstractFunction0.apply$mcV$sp(AbstractFunction0.scala:12)
	at scala.App.$anonfun$main$1$adapted(App.scala:76)
	at scala.collection.immutable.List.foreach(List.scala:378)
	at scala.App.main(App.scala:76)
	at scala.App.main$(App.scala:74)
	at org.ddahl.rscala.Main$.main(Main.scala:3)
	at org.ddahl.rscala.Main.main(Main.scala)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at scala.reflect.internal.util.ScalaClassLoader.$anonfun$run$2(ScalaClassLoader.scala:98)
	at scala.reflect.internal.util.ScalaClassLoader.asContext(ScalaClassLoader.scala:32)
	at scala.reflect.internal.util.ScalaClassLoader.asContext$(ScalaClassLoader.scala:30)
	at scala.reflect.internal.util.ScalaClassLoader$URLClassLoader.asContext(ScalaClassLoader.scala:129)
	at scala.reflect.internal.util.ScalaClassLoader.run(ScalaClassLoader.scala:98)
	at scala.reflect.internal.util.ScalaClassLoader.run$(ScalaClassLoader.scala:90)
	at scala.reflect.internal.util.ScalaClassLoader$URLClassLoader.run(ScalaClassLoader.scala:129)
	at scala.tools.nsc.CommonRunner.run(ObjectRunner.scala:22)
	at scala.tools.nsc.CommonRunner.run$(ObjectRunner.scala:21)
	at scala.tools.nsc.ObjectRunner$.run(ObjectRunner.scala:39)
	at scala.tools.nsc.CommonRunner.runAndCatch(ObjectRunner.scala:29)
	at scala.tools.nsc.CommonRunner.runAndCatch$(ObjectRunner.scala:28)
	at scala.tools.nsc.ObjectRunner$.runAndCatch(ObjectRunner.scala:39)
	at scala.tools.nsc.MainGenericRunner.runTarget$1(MainGenericRunner.scala:61)
	at scala.tools.nsc.MainGenericRunner.run$1(MainGenericRunner.scala:88)
	at scala.tools.nsc.MainGenericRunner.process(MainGenericRunner.scala:99)
	at scala.tools.nsc.MainGenericRunner$.main(MainGenericRunner.scala:104)
	at scala.tools.nsc.MainGenericRunner.main(MainGenericRunner.scala)
Caused by: java.lang.RuntimeException: Undefined identifier: x
	at org.ddahl.rscala.RClient.get(RClient.scala:418)
	at org.ddahl.rscala.RClient.getD1(RClient.scala:543)
	at $line309.$read$$iw$$iw$.$anonfun$res108$1(<console>:15)
	... 39 more
java.lang.reflect.InvocationTargetException
java.lang.RuntimeException: Undefined identifier: x
NULL
> callRFunction('myMean',1:100)
Here is am.
[1] 50.5
> 
> # Should be an R evaluation error because 'asfd' is not a package.
> tryCatch(s %@% 'R.eval("library(asdf)")',error=function(e) e)
Error in library(asdf) : there is no package called ‘asdf’
there is no package called ‘asdf’
java.lang.RuntimeException: Error in R evaluation.
  at org.ddahl.rscala.RClient.eval(RClient.scala:80)
  ... 54 elided
<simpleError in scalaEval(interpreter, snippet, parent.frame()): Error in evaluation.>
> s %~% 'R.evalD0("3+4")'
[1] 7
> 
> # Note that callbacks can be infinitely deep.
> s %~% "3+4"
[1] 7
> s %~% 'R.evalD0("""s %~% "2+3"""")'
[1] 5
> s %~% "3+4"
[1] 7
> 
> 
> 
