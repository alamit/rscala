> source("common.R",print.eval=TRUE)
# R version 3.4.0 (2017-04-21) # ramah # FALSE # FALSE
> set.seed(924234)
> 
> 
> sleep.time <- 0
> f <- function(x) { Sys.sleep(sleep.time); mean(x) }
> g <- function(x) { Sys.sleep(sleep.time); sd(x) }
> 
> 
> 
> # Native R code implementation
> doit0 <- function(x) {
+   y <- 2*x
+   c(f(y),g(y))
+ }
> 
> doit0(rnorm(10))
[1] 0.1013462 1.4964630
> 
> 
> 
> # Single callback in interpreted code.
> doit1 <- function(x) {
+   s$x <- x
+   s %@% 'R.set("y",x.map(2*_))'
+   c(s %~% 'R.evalD0("f(y)")',
+     s %~% 'R.evalD0("g(y)")')
+ }
> 
> doit1(rnorm(10))
[1] 0.6360252 2.5355099
> 
> 
> 
> # Multiple callbacks in interpreted code.
> doit2 <- function(x) {
+   s$x <- x
+   s %~% '
+     R.set("y",x.map(2*_))
+     Array(R.evalD0("f(y)"),
+           R.evalD0("g(y)"))
+   '
+ }
> 
> doit2(rnorm(10))
[1] -0.163821  1.921544
> 
> 
> 
> 
> # Multiple callbacks in compiled code.
> doit3 <- s$def(x=numeric()) %~% '
+   R.set("y",x.map(2*_))
+   Array(R.evalD0("f(y)"),
+         R.evalD0("g(y)"))
+ '
> 
> doit3(rnorm(10))
[1] -0.3438236  2.0255381
> 
> 
> 
> # Benchmarks
> 
> library(microbenchmark)
> 
> sleep.time <- 0
> microbenchmark(
+   doit0(rnorm(10)),
+   doit1(rnorm(10)),
+   doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=10
+ )
Unit: microseconds
             expr        min         lq        mean      median        uq
 doit0(rnorm(10))     68.054     95.535    319.0162    125.8225    133.69
 doit1(rnorm(10)) 350236.623 505513.630 650109.7940 647081.3705 767575.65
 doit2(rnorm(10)) 310900.054 419084.343 525875.8543 450559.2925 581619.30
 doit3(rnorm(10))   1795.973   2196.012   4219.4154   2447.1760   3788.32
         max neval
    2162.094    10
  982369.475    10
 1034826.568    10
   17709.968    10
> microbenchmark(
+   doit0(rnorm(10)),
+   #doit1(rnorm(10)),
+   #doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=1000
+ )
Unit: microseconds
             expr     min      lq       mean   median        uq       max neval
 doit0(rnorm(10))  17.926  28.248   39.28222  35.4495   47.0075  1143.276  1000
 doit3(rnorm(10)) 583.767 768.050 1062.01347 982.7200 1161.8990 14769.151  1000
> 
> 
> sleep.time <- 0.1
> microbenchmark(
+   doit0(rnorm(10)),
+   doit1(rnorm(10)),
+   doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=5
+ )
Unit: milliseconds
             expr      min       lq     mean   median       uq      max neval
 doit0(rnorm(10)) 200.3516 200.3665 200.3770 200.3719 200.3835 200.4114     5
 doit1(rnorm(10)) 515.3805 521.4601 617.6893 668.0933 682.4108 701.1020     5
 doit2(rnorm(10)) 503.7916 504.1520 523.8159 523.9302 528.5838 558.6216     5
 doit3(rnorm(10)) 201.7030 202.0046 203.7849 202.2973 205.0996 207.8197     5
> 
> 
