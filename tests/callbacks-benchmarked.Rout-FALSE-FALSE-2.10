> source("common.R",print.eval=TRUE)
# R version 3.3.3 (2017-03-06) # ramah # FALSE # FALSE
> set.seed(924234)
> 
> 
> sleep.time <- 0
> f <- function(x) { Sys.sleep(sleep.time); mean(x) }
> g <- function(x) { Sys.sleep(sleep.time); sd(x) }
> 
> 
> 
> # Native R code implementation
> doit0 <- function(x) {
+   y <- 2*x
+   c(f(y),g(y))
+ }
> 
> doit0(rnorm(10))
[1] 0.1013462 1.4964630
> 
> 
> 
> # Single callback in interpreted code.
> doit1 <- function(x) {
+   s$x <- x
+   s %@% 'R.set("y",x.map(2*_))'
+   c(s %~% 'R.evalD0("f(y)")',
+     s %~% 'R.evalD0("g(y)")')
+ }
> 
> doit1(rnorm(10))
[1] 0.6360252 2.5355099
> 
> 
> 
> # Multiple callbacks in interpreted code.
> doit2 <- function(x) {
+   s$x <- x
+   s %~% '
+     R.set("y",x.map(2*_))
+     Array(R.evalD0("f(y)"),
+           R.evalD0("g(y)"))
+   '
+ }
> 
> doit2(rnorm(10))
[1] -0.163821  1.921544
> 
> 
> 
> 
> # Multiple callbacks in compiled code.
> doit3 <- s$def(x=numeric()) %~% '
+   R.set("y",x.map(2*_))
+   Array(R.evalD0("f(y)"),
+         R.evalD0("g(y)"))
+ '
> 
> doit3(rnorm(10))
[1] -0.5309233  1.9064429
> 
> 
> 
> # Benchmarks
> 
> library(microbenchmark)
> 
> sleep.time <- 0
> microbenchmark(
+   doit0(rnorm(10)),
+   doit1(rnorm(10)),
+   doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=10
+ )
Unit: microseconds
             expr        min         lq       mean     median         uq
 doit0(rnorm(10))     43.032     51.123     93.910     99.918    113.591
 doit1(rnorm(10)) 252390.162 554133.440 563554.098 578826.235 642506.230
 doit2(rnorm(10)) 228626.527 247915.897 389719.961 429917.687 467408.335
 doit3(rnorm(10))   2005.302   2073.633   5907.914   2202.252   3705.391
        max neval
    157.443    10
 756630.412    10
 541248.559    10
  22260.740    10
> microbenchmark(
+   doit0(rnorm(10)),
+   #doit1(rnorm(10)),
+   #doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=1000
+ )
Unit: microseconds
             expr     min      lq      mean   median       uq       max neval
 doit0(rnorm(10))  16.567  20.155  28.24572  28.0475  32.2780   104.563  1000
 doit3(rnorm(10)) 598.333 763.317 909.83118 788.2625 844.0335 11729.173  1000
> 
> 
> sleep.time <- 0.1
> microbenchmark(
+   doit0(rnorm(10)),
+   doit1(rnorm(10)),
+   doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=5
+ )
Unit: milliseconds
             expr      min       lq     mean   median       uq      max neval
 doit0(rnorm(10)) 200.3366 200.4245 200.4283 200.4362 200.4377 200.5063     5
 doit1(rnorm(10)) 367.0902 399.7701 426.9953 404.8362 455.7250 507.5553     5
 doit2(rnorm(10)) 278.1730 317.1048 377.7731 383.5202 407.4156 502.6518     5
 doit3(rnorm(10)) 201.9593 202.0693 202.3982 202.4490 202.6698 202.8437     5
> 
> 
