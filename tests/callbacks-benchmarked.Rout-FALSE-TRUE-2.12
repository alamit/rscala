> source("common.R",print.eval=TRUE)
# R version 3.3.2 (2016-10-31) # sidon # FALSE # TRUE
> set.seed(924234)
> 
> 
> sleep.time <- 0
> f <- function(x) { Sys.sleep(sleep.time); mean(x) }
> g <- function(x) { Sys.sleep(sleep.time); sd(x) }
> 
> 
> 
> # Native R code implementation
> doit0 <- function(x) {
+   y <- 2*x
+   c(f(y),g(y))
+ }
> 
> doit0(rnorm(10))
[1] 0.1013462 1.4964630
> 
> 
> 
> # Single callback in interpreted code.
> doit1 <- function(x) {
+   s$x <- x
+   s %@% 'R.set("y",x.map(2*_))'
+   c(s %~% 'R.evalD0("f(y)")',
+     s %~% 'R.evalD0("g(y)")')
+ }
> 
> doit1(rnorm(10))
[1] 0.6360252 2.5355099
> 
> 
> 
> # Multiple callbacks in interpreted code.
> doit2 <- function(x) {
+   s$x <- x
+   s %~% '
+     R.set("y",x.map(2*_))
+     Array(R.evalD0("f(y)"),
+           R.evalD0("g(y)"))
+   '
+ }
> 
> doit2(rnorm(10))
[1] -0.163821  1.921544
> 
> 
> 
> 
> # Multiple callbacks in compiled code.
> doit3 <- s$def(x=numeric()) %~% '
+   R.set("y",x.map(2*_))
+   Array(R.evalD0("f(y)"),
+         R.evalD0("g(y)"))
+ '
> 
> doit3(rnorm(10))
[1] -0.5309233  1.9064429
> 
> 
> 
> # Benchmarks
> 
> library(microbenchmark)
> 
> sleep.time <- 0
> microbenchmark(
+   doit0(rnorm(10)),
+   doit1(rnorm(10)),
+   doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=10
+ )
Unit: microseconds
             expr        min         lq        mean      median          uq
 doit0(rnorm(10))     41.188    114.648    116.7913    122.2795     133.101
 doit1(rnorm(10)) 616452.838 681246.581 886404.6925 773796.9615 1077284.727
 doit2(rnorm(10)) 368227.017 431667.960 538098.1870 561985.6405  630159.252
 doit3(rnorm(10))   1866.389   1911.875   3533.9310   2504.2220    2762.416
        max neval
     169.43    10
 1484132.58    10
  733396.50    10
   11686.78    10
> microbenchmark(
+   doit0(rnorm(10)),
+   #doit1(rnorm(10)),
+   #doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=1000
+ )
Unit: microseconds
             expr     min        lq       mean    median       uq      max
 doit0(rnorm(10))  20.824   41.3805   67.57484   59.5595   86.252  1929.21
 doit3(rnorm(10)) 828.663 1576.6805 1955.00634 1746.1455 1893.800 19703.08
 neval
  1000
  1000
> 
> 
> sleep.time <- 0.1
> microbenchmark(
+   doit0(rnorm(10)),
+   doit1(rnorm(10)),
+   doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=5
+ )
Unit: milliseconds
             expr      min       lq     mean    median        uq       max
 doit0(rnorm(10)) 200.3583 200.4252 200.4340  200.4532  200.4605  200.4731
 doit1(rnorm(10)) 610.1102 891.6306 946.9829 1011.2123 1071.6137 1150.3476
 doit2(rnorm(10)) 455.8719 481.5168 558.7096  558.5810  635.4681  662.1103
 doit3(rnorm(10)) 201.5869 202.0298 203.6531  202.7486  202.8286  209.0717
 neval
     5
     5
     5
     5
> 
> 
