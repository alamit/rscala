> source("common.R",print.eval=TRUE)
# R version 3.3.3 (2017-03-06) # ramah # FALSE # TRUE
> set.seed(924234)
> 
> 
> sleep.time <- 0
> f <- function(x) { Sys.sleep(sleep.time); mean(x) }
> g <- function(x) { Sys.sleep(sleep.time); sd(x) }
> 
> 
> 
> # Native R code implementation
> doit0 <- function(x) {
+   y <- 2*x
+   c(f(y),g(y))
+ }
> 
> doit0(rnorm(10))
[1] 0.1013462 1.4964630
> 
> 
> 
> # Single callback in interpreted code.
> doit1 <- function(x) {
+   s$x <- x
+   s %@% 'R.set("y",x.map(2*_))'
+   c(s %~% 'R.evalD0("f(y)")',
+     s %~% 'R.evalD0("g(y)")')
+ }
> 
> doit1(rnorm(10))
[1] 0.6360252 2.5355099
> 
> 
> 
> # Multiple callbacks in interpreted code.
> doit2 <- function(x) {
+   s$x <- x
+   s %~% '
+     R.set("y",x.map(2*_))
+     Array(R.evalD0("f(y)"),
+           R.evalD0("g(y)"))
+   '
+ }
> 
> doit2(rnorm(10))
[1] -0.163821  1.921544
> 
> 
> 
> 
> # Multiple callbacks in compiled code.
> doit3 <- s$def(x=numeric()) %~% '
+   R.set("y",x.map(2*_))
+   Array(R.evalD0("f(y)"),
+         R.evalD0("g(y)"))
+ '
> 
> doit3(rnorm(10))
[1] -0.5309233  1.9064429
> 
> 
> 
> # Benchmarks
> 
> library(microbenchmark)
> 
> sleep.time <- 0
> microbenchmark(
+   doit0(rnorm(10)),
+   doit1(rnorm(10)),
+   doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=10
+ )
Unit: microseconds
             expr       min         lq        mean     median         uq
 doit0(rnorm(10))     31.26     39.177     84.5458     90.315    108.235
 doit1(rnorm(10)) 678308.16 728093.468 873333.3729 855300.949 922610.590
 doit2(rnorm(10)) 359515.59 435480.807 487489.4199 484963.937 520840.076
 doit3(rnorm(10))   1622.40   1760.460   2130.9696   2025.800   2397.275
         max neval
     147.254    10
 1256623.369    10
  679159.058    10
    2961.682    10
> microbenchmark(
+   doit0(rnorm(10)),
+   #doit1(rnorm(10)),
+   #doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=1000
+ )
Unit: microseconds
             expr     min       lq       mean    median        uq       max
 doit0(rnorm(10))  16.766  29.2775   40.31351   36.2365   49.6785   104.852
 doit3(rnorm(10)) 664.571 945.7165 1432.02574 1278.9545 1505.8365 27098.563
 neval
  1000
  1000
> 
> 
> sleep.time <- 0.1
> microbenchmark(
+   doit0(rnorm(10)),
+   doit1(rnorm(10)),
+   doit2(rnorm(10)),
+   doit3(rnorm(10)),
+   times=5
+ )
Unit: milliseconds
             expr      min       lq     mean   median       uq      max neval
 doit0(rnorm(10)) 200.3751 200.3806 203.3377 200.4014 200.4230 215.1084     5
 doit1(rnorm(10)) 685.2343 705.8032 741.6820 707.2716 789.1017 820.9991     5
 doit2(rnorm(10)) 407.8821 409.3544 426.4433 410.7713 449.2424 454.9663     5
 doit3(rnorm(10)) 201.8985 202.1206 204.8729 202.1677 205.6218 212.5557     5
> 
> 
